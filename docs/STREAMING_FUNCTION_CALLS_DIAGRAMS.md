# Streaming Function Calls - Visual Diagrams

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Client Application                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │   Browser   │  │   Mobile    │  │     CLI     │  │     API     │   │
│  │  WebSocket  │  │     App     │  │   Client    │  │   Client    │   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │
│         │                 │                 │                 │          │
└─────────┼─────────────────┼─────────────────┼─────────────────┼─────────┘
          │                 │                 │                 │
          └─────────────────┴─────────────────┴─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            Agent Instance Layer                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      Streaming Event Router                     │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │    │
│  │  │  Token   │  │Function  │  │  Error   │  │Complete  │      │    │
│  │  │ Handler  │  │  Call    │  │ Handler  │  │ Handler  │      │    │
│  │  └─────┬────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘      │    │
│  └────────┼─────────────┼─────────────┼─────────────┼────────────┘    │
│           │             │             │             │                   │
│           ▼             ▼             ▼             ▼                   │
│  ┌─────────────────────────────────────────────────────────────┐      │
│  │              Streaming Function Handler                      │      │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │      │
│  │  │ Accumulator │  │   Event     │  │    Tool     │        │      │
│  │  │   State     │  │  Processor  │  │  Executor   │        │      │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │      │
│  └──────────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          OpenAI API Integration                          │
│  ┌────────────────────────────┐  ┌────────────────────────────┐       │
│  │      Chat API Client       │  │   Responses API Client     │       │
│  │  ┌──────────────────────┐  │  │  ┌──────────────────────┐  │       │
│  │  │   SSE Event Parser   │  │  │  │  Enhanced SSE Parser │  │       │
│  │  └──────────────────────┘  │  │  └──────────────────────┘  │       │
│  └────────────────────────────┘  └────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
```

## Streaming Event Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Streaming Timeline                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  T0 ──┬── Request Initiated                                             │
│       │   POST /v1/chat/completions                                     │
│       │   {stream: true, tools: [...]}                                  │
│       │                                                                  │
│  T1 ──┼── Stream Start Event                                           │
│       │   ┌─────────────────┐                                          │
│       │   │ {stream_start}  │ ──► Client notified                      │
│       │   └─────────────────┘                                          │
│       │                                                                  │
│  T2 ──┼── Content Streaming                                            │
│       │   ┌──┐ ┌──┐ ┌──┐ ┌──┐                                        │
│       │   │H │ │e │ │l │ │l │ ──► Tokens sent immediately             │
│       │   └──┘ └──┘ └──┘ └──┘                                        │
│       │                                                                  │
│  T3 ──┼── Function Call Detection                                      │
│       │   ┌─────────────────────┐                                      │
│       │   │ Function: search    │ ──► Accumulation starts              │
│       │   └─────────────────────┘                                      │
│       │                                                                  │
│  T4 ──┼── Arguments Streaming                                          │
│       │   ┌───┐ ┌───┐ ┌───┐                                          │
│       │   │{" │ │qu │ │er │ ──► Delta accumulation                    │
│       │   └───┘ └───┘ └───┘                                          │
│       │                                                                  │
│  T5 ──┼── Function Complete                                            │
│       │   ┌─────────────────────┐                                      │
│       │   │ Arguments complete  │ ──► Ready for execution              │
│       │   └─────────────────────┘                                      │
│       │                                                                  │
│  T6 ──┼── Parallel Execution                                           │
│       │   ┌─────┐ ┌─────┐ ┌─────┐                                    │
│       │   │Tool1│ │Tool2│ │Tool3│ ──► Execute concurrently            │
│       │   └─────┘ └─────┘ └─────┘                                    │
│       │                                                                  │
│  T7 ──┼── Results & Continuation                                       │
│       │   ┌──┐ ┌──┐ ┌──┐ ┌──┐                                        │
│       │   │B │ │a │ │s │ │e │ ──► Continue with results               │
│       │   └──┘ └──┘ └──┘ └──┘                                        │
│       │                                                                  │
│  T8 ──┴── Stream Complete                                              │
│       │   ┌─────────────────┐                                          │
│       │   │ {stream_done}   │ ──► Final response sent                  │
│       │   └─────────────────┘                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Function Call Accumulation Process

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Function Call Delta Accumulation                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Chunk 1:  {"index": 0, "function": {"name": "search"}}                │
│     ↓                                                                    │
│  ┌──────────────────────────────────────────┐                          │
│  │ Accumulator State:                       │                          │
│  │ tool_call_map: {                         │                          │
│  │   0: {                                   │                          │
│  │     "name": "search",                    │                          │
│  │     "arguments": ""                      │                          │
│  │   }                                      │                          │
│  │ }                                        │                          │
│  └──────────────────────────────────────────┘                          │
│                                                                          │
│  Chunk 2:  {"index": 0, "function": {"arguments": "{\"query\":"}}      │
│     ↓                                                                    │
│  ┌──────────────────────────────────────────┐                          │
│  │ Accumulator State:                       │                          │
│  │ tool_call_map: {                         │                          │
│  │   0: {                                   │                          │
│  │     "name": "search",                    │                          │
│  │     "arguments": "{\"query\":"           │ ← Concatenated          │
│  │   }                                      │                          │
│  │ }                                        │                          │
│  └──────────────────────────────────────────┘                          │
│                                                                          │
│  Chunk 3:  {"index": 0, "function": {"arguments": " \"weather\"}}"}}   │
│     ↓                                                                    │
│  ┌──────────────────────────────────────────┐                          │
│  │ Accumulator State:                       │                          │
│  │ tool_call_map: {                         │                          │
│  │   0: {                                   │                          │
│  │     "name": "search",                    │                          │
│  │     "arguments": "{\"query\": \"weather\"}}" │ ← Complete!         │
│  │   }                                      │                          │
│  │ }                                        │                          │
│  └──────────────────────────────────────────┘                          │
│                                                                          │
│  On Completion:                                                          │
│     ↓                                                                    │
│  ┌──────────────────────────────────────────┐                          │
│  │ Accumulator State:                       │                          │
│  │ tool_calls: [                            │ ← Moved to list          │
│  │   {                                      │                          │
│  │     "name": "search",                    │                          │
│  │     "arguments": "{\"query\": \"weather\"}}" │                      │
│  │   }                                      │                          │
│  │ ],                                       │                          │
│  │ tool_call_map: {}                        │ ← Cleared               │
│  └──────────────────────────────────────────┘                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Parallel Tool Execution

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Parallel Tool Execution Flow                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Multiple Tool Calls Detected:                                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │
│  │   search    │  │ calculator  │  │ file_read   │                    │
│  │ "weather"   │  │  "2 + 2"    │  │ "data.txt"  │                    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                    │
│         │                 │                 │                            │
│         ▼                 ▼                 ▼                            │
│  ┌─────────────────────────────────────────────────────┐               │
│  │              Parallel Execution Manager              │               │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐            │               │
│  │  │Process 1│  │Process 2│  │Process 3│            │               │
│  │  └────┬────┘  └────┬────┘  └────┬────┘            │               │
│  └───────┼─────────────┼─────────────┼─────────────────┘               │
│          │             │             │                                   │
│          ▼             ▼             ▼                                   │
│    ┌──────────┐  ┌──────────┐  ┌──────────┐                           │
│    │ HTTP API │  │  Local   │  │   File   │                           │
│    │   Call   │  │  Calc    │  │   I/O    │                           │
│    └─────┬────┘  └─────┬────┘  └─────┬────┘                           │
│          │             │             │                                   │
│          │ 200ms      │ 5ms        │ 15ms                              │
│          ▼             ▼             ▼                                   │
│    ┌──────────┐  ┌──────────┐  ┌──────────┐                           │
│    │ "Sunny,  │  │    "4"    │  │ "Hello,  │                           │
│    │  72°F"   │  │           │  │  World"  │                           │
│    └─────┬────┘  └─────┬────┘  └─────┬────┘                           │
│          │             │             │                                   │
│          └─────────────┴─────────────┘                                  │
│                        │                                                 │
│                        ▼                                                 │
│              ┌─────────────────┐                                        │
│              │ Results Ordered │  Total Time: 200ms (max)              │
│              │   Collector     │  Not 220ms (sum)                      │
│              └─────────────────┘                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Event Message Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Event Message Structure                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  stream_start                                                            │
│  ┌─────────────────────────────────┐                                   │
│  │ {                               │                                   │
│  │   type: "stream_start",         │                                   │
│  │   data: {                       │                                   │
│  │     agent_id: "agent_123",      │                                   │
│  │     model: "gpt-4o",            │                                   │
│  │     timestamp: 1234567890       │                                   │
│  │   }                             │                                   │
│  │ }                               │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                          │
│  stream_token                                                            │
│  ┌─────────────────────────────────┐                                   │
│  │ {                               │                                   │
│  │   type: "stream_token",         │                                   │
│  │   data: "Hello, I'll help "     │                                   │
│  │ }                               │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                          │
│  stream_function_call_started                                            │
│  ┌─────────────────────────────────┐                                   │
│  │ {                               │                                   │
│  │   type: "stream_function_call_started",                             │
│  │   data: {                       │                                   │
│  │     id: "call_abc123",          │                                   │
│  │     type: "function",           │                                   │
│  │     function: {                 │                                   │
│  │       name: "web_search",       │                                   │
│  │       arguments: ""             │                                   │
│  │     }                           │                                   │
│  │   }                             │                                   │
│  │ }                               │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                          │
│  stream_function_arguments_delta                                         │
│  ┌─────────────────────────────────┐                                   │
│  │ {                               │                                   │
│  │   type: "stream_function_arguments_delta",                          │
│  │   data: {                       │                                   │
│  │     index: 0,                   │                                   │
│  │     delta: "{\"query\": \"",    │                                   │
│  │   }                             │                                   │
│  │ }                               │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                          │
│  stream_tool_result                                                      │
│  ┌─────────────────────────────────┐                                   │
│  │ {                               │                                   │
│  │   type: "stream_tool_result",   │                                   │
│  │   data: {                       │                                   │
│  │     tool_call: {                │                                   │
│  │       name: "web_search",       │                                   │
│  │       id: "call_abc123"         │                                   │
│  │     },                          │                                   │
│  │     result: {                   │                                   │
│  │       status: "success",        │                                   │
│  │       data: "Weather: 72°F..."  │                                   │
│  │     }                           │                                   │
│  │   }                             │                                   │
│  │ }                               │                                   │
│  └─────────────────────────────────┘                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## State Machine Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Streaming State Machine                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│    ┌─────────┐                                                          │
│    │  IDLE   │                                                          │
│    └────┬────┘                                                          │
│         │ stream_chat()                                                  │
│         ▼                                                                │
│    ┌─────────┐                                                          │
│    │STARTING │──────── timeout ────────┐                               │
│    └────┬────┘                         │                               │
│         │ stream_start                  │                               │
│         ▼                              ▼                               │
│    ┌─────────┐                    ┌─────────┐                         │
│    │STREAMING│                    │  ERROR  │                         │
│    └────┬────┘                    └─────────┘                         │
│         │                              ▲                               │
│         ├── stream_token ──┐           │                               │
│         │                  │           │                               │
│         ├── function_start─┼─┐         │                               │
│         │                  │ │         │                               │
│         ├── error ─────────┼─┼─────────┘                               │
│         │                  │ │                                          │
│         ▼                  ▼ ▼                                          │
│    ┌─────────┐         ┌─────────┐                                    │
│    │FUNCTION │◄────────│CONTENT  │                                    │
│    │ CALLING │         │STREAMING│                                    │
│    └────┬────┘         └─────────┘                                    │
│         │                    ▲                                          │
│         │ function_complete  │                                          │
│         ▼                    │                                          │
│    ┌─────────┐              │                                          │
│    │EXECUTING│──── results ──┘                                          │
│    └────┬────┘                                                          │
│         │                                                               │
│         │ all_complete                                                  │
│         ▼                                                               │
│    ┌─────────┐                                                          │
│    │COMPLETE │                                                          │
│    └─────────┘                                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Performance Metrics Visualization

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Performance Characteristics                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Response Time Breakdown (typical 1000-token response with 2 functions) │
│                                                                          │
│  0ms    100ms   200ms   300ms   400ms   500ms   600ms   700ms   800ms │
│  │───────┼───────┼───────┼───────┼───────┼───────┼───────┼───────│  │
│  │                                                                  │  │
│  │▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│  │
│  │ Setup  │                                                         │  │
│  │ (50ms) │                                                         │  │
│  │        │                                                         │  │
│  │        │▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░░│  │
│  │        │    First Token (150ms)        │                        │  │
│  │        │                               │                        │  │
│  │        │                               │▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│  │
│  │        │                               │ Content Stream (200ms)│  │
│  │        │                               │                        │  │
│  │        │                               │                    ▓▓▓▓│  │
│  │        │                               │              Function  │  │
│  │        │                               │             Detection  │  │
│  │        │                               │               (50ms)   │  │
│  │        │                               │                        │  │
│  │        │                               │                    ░░░░│  │
│  │        │                               │                Tool    │  │
│  │        │                               │             Execution  │  │
│  │        │                               │              (100ms)   │  │
│  │        │                               │                        │  │
│  │        │                               │                        │▓▓│
│  │        │                               │                     Final│
│  │        │                               │                   Stream│
│  │        │                               │                    (50ms)│
│  │───────┼───────┼───────┼───────┼───────┼───────┼───────┼───────│  │
│                                                                          │
│  Legend: ▓ Active Processing  ░ Waiting/Network                         │
│                                                                          │
│  Metrics:                                                                │
│  • Time to First Token: 200ms                                          │
│  • Tokens per Second: ~100 tokens/sec                                  │
│  • Function Execution: 100ms (parallel)                                │
│  • Total Response Time: 800ms                                          │
│  • Overhead vs Non-streaming: ~50ms                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Error Handling Hierarchy                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Stream Level Errors                                                     │
│  ┌────────────────────┐                                                 │
│  │   Network Error    │──┐                                              │
│  └────────────────────┘  │                                              │
│  ┌────────────────────┐  │     ┌─────────────────┐                    │
│  │   Timeout Error    │──┼────▶│  Error Handler  │                    │
│  └────────────────────┘  │     └────────┬────────┘                    │
│  ┌────────────────────┐  │              │                              │
│  │   Parse Error      │──┘              ▼                              │
│  └────────────────────┘         ┌─────────────────┐                    │
│                                  │ Recovery Logic  │                    │
│  Function Level Errors           └────────┬────────┘                    │
│  ┌────────────────────┐                  │                              │
│  │  Tool Not Found    │──┐               ▼                              │
│  └────────────────────┘  │     ┌─────────────────────┐                │
│  ┌────────────────────┐  │     │  Partial Response   │                │
│  │  Execution Error   │──┼────▶│    Construction     │                │
│  └────────────────────┘  │     └─────────┬───────────┘                │
│  ┌────────────────────┐  │               │                             │
│  │  Argument Error    │──┘               ▼                             │
│  └────────────────────┘         ┌─────────────────────┐                │
│                                  │   Send to Client    │                │
│                                  │  - Partial content  │                │
│                                  │  - Error details    │                │
│                                  │  - Recovery hints   │                │
│                                  └─────────────────────┘                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Memory Usage Pattern

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Memory Usage Over Time                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Memory                                                                  │
│  (MB)                                                                    │
│   10│                                           ┌─┐                      │
│     │                                           │ │ Peak during         │
│    9│                                           │ │ tool execution      │
│     │                                           │ │                     │
│    8│                                      ┌────┤ ├────┐                │
│     │                                      │    │ │    │                │
│    7│                                      │    │ │    │                │
│     │                                      │    └─┘    │                │
│    6│                               ┌──────┤           │                │
│     │                               │      │           │                │
│    5│                        ┌──────┤      │           │                │
│     │                        │      │      │           │                │
│    4│                 ┌──────┤      │      │           │                │
│     │                 │      │      │      │           │                │
│    3│          ┌──────┤      │      │      │           └───────┐       │
│     │          │      │      │      │      │                   │       │
│    2│   ┌──────┤      │      │      │      │                   │       │
│     │   │      │      │      │      │      │                   │       │
│    1│───┤      │      │      │      │      │                   └───────│
│     │                                                                   │
│    0└───┴──────┴──────┴──────┴──────┴──────┴───────────────────┴──────┘
│      Start  Tokens  Function  Args   Exec   Results      Done    Cleanup
│             Stream  Detected  Stream                                     │
│                                                                          │
│  Key Points:                                                             │
│  • Gradual increase during content streaming                           │
│  • Spike during parallel tool execution                                │
│  • Efficient cleanup after completion                                  │
│  • No memory leaks - returns to baseline                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Integration Example Visual

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    WebSocket Integration Example                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Browser                          Server                                 │
│  ┌─────────────┐                 ┌─────────────┐                       │
│  │  JavaScript │                 │   Erlang    │                       │
│  │    Client   │                 │   Handler   │                       │
│  └──────┬──────┘                 └──────┬──────┘                       │
│         │                                │                               │
│         │  ws://localhost:8080/ws       │                               │
│         ├───────────────────────────────►│                               │
│         │                                │                               │
│         │  {"action": "stream_chat",     │                               │
│         │   "message": "Hello"}          │                               │
│         ├───────────────────────────────►│                               │
│         │                                ├──┐                            │
│         │                                │  │ agent:stream_chat()       │
│         │                                │◄─┘                            │
│         │                                │                               │
│         │  {"type": "stream_start"}      │                               │
│         │◄───────────────────────────────┤                               │
│         │                                │                               │
│         │  {"type": "token",             │                               │
│         │   "data": "Hi"}                │                               │
│         │◄───────────────────────────────┤                               │
│         │                                │                               │
│         │  {"type": "function_start",    │                               │
│         │   "data": {...}}               │                               │
│         │◄───────────────────────────────┤                               │
│         │                                │                               │
│         │  {"type": "complete",          │                               │
│         │   "data": {...}}               │                               │
│         │◄───────────────────────────────┤                               │
│         │                                │                               │
│                                                                          │
│  JavaScript:                             Erlang:                        │
│  ┌────────────────────────────┐        ┌────────────────────────────┐ │
│  │ ws.onmessage = (event) => { │        │ websocket_info({         │ │
│  │   const msg = JSON.parse(   │        │   stream_token, Token    │ │
│  │     event.data              │        │ }, State) ->             │ │
│  │   );                        │        │   {reply, {text,         │ │
│  │   if (msg.type === 'token')│        │     jsx:encode(#{        │ │
│  │     appendToChat(msg.data); │        │       type => token,     │ │
│  │ }                           │        │       data => Token      │ │
│  └────────────────────────────┘        │     })}, State}.         │ │
│                                         └────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Summary Flowchart

```
┌─────────────────────────────────────────────────────────────────────────┐
│              Complete Streaming Function Call Flow                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  START                                                                   │
│    │                                                                     │
│    ▼                                                                     │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐  │
│  │ User sends      │     │ Agent receives  │     │ OpenAI API      │  │
│  │ message         ├────▶│ & processes     ├────▶│ streaming call  │  │
│  └─────────────────┘     └─────────────────┘     └────────┬────────┘  │
│                                                            │            │
│                          ┌─────────────────────────────────┘            │
│                          ▼                                              │
│                    ┌───────────┐                                        │
│                    │  Stream   │                                        │
│                    │  Events   │                                        │
│                    └─────┬─────┘                                        │
│                          │                                              │
│         ┌────────────────┼────────────────┐                           │
│         ▼                ▼                ▼                           │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐                      │
│   │  Tokens  │    │ Function │    │  Errors  │                      │
│   │          │    │  Calls   │    │          │                      │
│   └────┬─────┘    └────┬─────┘    └────┬─────┘                      │
│        │               │               │                              │
│        ▼               ▼               ▼                              │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐                      │
│   │ Send to  │    │ Aggregate│    │  Handle  │                      │
│   │  client  │    │ & Execute│    │ & Retry  │                      │
│   └──────────┘    └────┬─────┘    └──────────┘                      │
│                        │                                              │
│                        ▼                                              │
│                  ┌──────────┐                                        │
│                  │  Results │                                        │
│                  └────┬─────┘                                        │
│                       │                                              │
│                       ▼                                              │
│                 ┌───────────┐                                        │
│                 │ Continue  │                                        │
│                 │ Streaming │                                        │
│                 └─────┬─────┘                                        │
│                       │                                              │
│                       ▼                                              │
│                    COMPLETE                                          │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```